<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>##터치애드:맞춤분석신청##</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no" />
    <link rel="stylesheet" href="touchad.css" />
  </head>
  <body>
    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" class="overlay">
      <div class="overlay-content">
        <div class="spinner"></div>
        <p>데이터를 분석하고 있습니다...</p>
        <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8">잠시만 기다려주세요</p>
      </div>
    </div>

    <!-- 실제 데이터 표시 영역 -->
    <div id="result"></div>
    <a href="#" class="site-logo">TOUCH AD</a>

    <main class="scroll-container">
      <div class="scroll-indicator">
        <div class="scroll-dot active" data-section="hero-section"></div>
        <div class="scroll-dot" data-section="usp-content"></div>
        <div class="scroll-dot" data-section="site-footer"></div>
      </div>

      <section id="hero-section" class="scroll-section">
        <video class="bg-video" autoplay muted loop playsinline preload="auto">
          <source src="intro.mp4" type="video/mp4" />
        </video>
        <div class="video-overlay"></div>
        <div class="head-copy-wrapper">
          <h1 class="animate-lines">
            <span class="line uspH">내일, 원장님 병원에 방문할 사람은 얼마나 될까요?</span>
            <span class="line"
              >이동과 소비 데이터 속에는 병원을 찾을 준비가 된 사람들이 있습니다.
              <span class="usp"
                >TOUCH AD는 교통카드와 신용카드 데이터를 바탕으로<br />병원이 자연스럽게 닿을 수 있는 사람들의 이동 흐름을 분석합니다.</span
              ></span
            >
            <!-- <span class="line subline">TOUCH AD는 이 데이터를 활용한 마케팅 솔루션입니다.<br><br></span> -->
            <span class="line now"><br />지금 스캔해 보세요</span>
          </h1>
        </div>

        <div class="glass-form-wrapper">
          <div class="form-indicator">
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
          </div>
          <form id="multi-step-form" onsubmit="return false;">
            <div class="form-steps-container">
              <div class="form-step">
                <h2 class="form-section__title">기본 정보</h2>
                <div class="form-group">
                  <label for="name">성함<span class="needed"> *</span></label>
                  <input type="text" id="name" name="name" required placeholder="예) 장준혁" />
                </div>
                <div class="form-group">
                  <label for="phone">연락처<span class="needed"> *</span></label>
                  <input type="tel" id="phone" name="phone" required placeholder="예) 010-1234-5678" pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}" />
                </div>
                <div class="form-group">
                  <label for="email">이메일</label>
                  <input type="email" id="email" name="email" placeholder="doctor@sample.com" />
                </div>
              </div>
              <div class="form-step">
                <h2 class="form-section__title">병원 정보</h2>
                <div class="form-group">
                  <label for="hospital-name">병원이름<span class="needed"> *</span></label>
                  <input type="text" id="hospital-name" name="hospital-name" placeholder="예) 브라운성형외과" />
                </div>
                <div class="form-group">
                  <label for="specialty">전문진료분야<span class="needed"> *</span></label>
                  <select id="specialty" name="specialty" required>
                    <option value="">선택해주세요</option>
                    <option value="미용원" name="성형외과">성형외과</option>
                    <option value="피부미용원" name="피부과">피부과</option>
                    <option value="종합병원" name="내과">내과</option>
                    <option value="일반·치과·한방병원" name="정형외과">정형외과</option>
                    <option value="유사의료업" name="기타">기타</option>
                  </select>
                  <p class="form-tip">원장님의 진료 분야에 맞춰, 연관도 높은 카드 소비 데이터를 기반으로 고객 흐름을 분석합니다.</p>
                </div>
              </div>

              <div class="form-step">
                <h2 class="form-section__title">위치 정보</h2>
                <div class="form-group">
                  <label for="address-base">병원 주소<span class="needed"> *</span></label>
                  <div class="address-search-group">
                    <input
                      type="text"
                      id="address-base"
                      class="search-input"
                      name="address-base"
                      required
                      readonly
                      placeholder="시/군/구, 읍/면/동"
                      color="#ffffff"
                    />
                    <button type="button" class="search-button">우편번호 검색</button>
                  </div>
                </div>
                <div class="form-group">
                  <label for="address-detail">상세 주소<span class="needed"> *</span></label>
                  <input type="text" id="address-detail" name="address-detail" required placeholder="상세 주소를 입력해주세요" />
                  <p class="form-tip">원장님의 병원의 위치를 중심으로, 도달 가능한 생활권 내 이동 흐름을 분석합니다.</p>
                </div>
              </div>

              <div class="form-step">
                <h2 class="form-section__title">성별, 연령 정보</h2>
                <div class="form-group">
                  <label for="gender">성별<span class="needed"> *</span></label>
                  <select id="gender" name="gender" required>
                    <option value="">선택해주세요</option>
                    <option value="M" name="남성">남성</option>
                    <option value="F" name="여성">여성</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="age">연령<span class="needed"> *</span></label>
                  <select id="age" name="age" required>
                    <option value="">선택해주세요</option>
                    <option value="A" name="10대 이하">10대 이하</option>
                    <option value="B" name="20대">20대</option>
                    <option value="C" name="30대">30대</option>
                    <option value="D" name="40대">40대</option>
                    <option value="E" name="50대">50대</option>
                    <option value="F" name="60대">60대</option>
                    <option value="G" name="70대 이상">70대 이상</option>
                  </select>
                  <p class="form-tip">원장님께서 궁금하신 성별과 연령대를 선택해주세요.</p>
                </div>
                <div class="form-group consent">
                  <input type="checkbox" id="privacy-consent" name="privacy-consent" required />
                  <label for="privacy-consent">개인 정보 수집에 동의합니다.<span class="needed"> *</span></label>
                </div>
              </div>
            </div>
          </form>

          <div class="form-navigation">
            <button class="nav-button prev-button" style="display: none">이전</button>
            <button class="nav-button next-button disabled">다음</button>
            <button class="nav-button submit-button" style="display: none">제출</button>
          </div>
        </div>
      </section>

      <section id="usp-content" class="scroll-section" style="display: none"></section>

      <footer class="site-footer">
        <div class="footer-container">
          <div class="footer-info-wrapper">
            <div class="footer-info--left">
              <span class="footer-info--co">한국글로벌헬스케어사업협동조합</span>
              서울 서초구 강남대로 331, 광일빌딩 20층 02 554 2929 | kogha@polestarhc.com
              <a href="http://www.kogha.or.kr/" class="footer-link">http://www.kogha.or.kr</a>
            </div>
            <div class="footer-info--right">
              <span class="footer-info--co">(주)런커뮤니케이션즈</span>
              서울시 성동구 뚝섬로1길 25 서울숲 한라에코밸리 903호 070 4442 3344 | srkim@runcomm.co.kr
              <a href="http://runcomm.co.kr" class="footer-link">http://runcomm.co.kr</a>
            </div>
          </div>
          <div class="footer-copyright">ⓒ 2025 KOREAN GLOBAL HEALTHCARE BUSINESS ASSOCIATION. All Right Reserved.</div>
        </div>
      </footer>
    </main>

    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const formStepsContainer = document.querySelector(".form-steps-container");
        const formDots = document.querySelectorAll(".form-indicator .step-dot");
        const formSteps = document.querySelectorAll(".form-step");
        const prevButton = document.querySelector(".prev-button");
        const nextButton = document.querySelector(".next-button");
        const submitButton = document.querySelector(".submit-button");
        const nameInput = document.getElementById("name");
        const phoneInput = document.getElementById("phone");
        const emailInput = document.getElementById("email");
        const hospitalNameInput = document.getElementById("hospital-name");
        const specialtySelect = document.getElementById("specialty");
        const addressBaseInput = document.getElementById("address-base");
        const addressDetailInput = document.getElementById("address-detail");
        const addressBox = document.querySelector(".address-search-group");
        const privacyConsentCheckbox = document.getElementById("privacy-consent");
        const genderSelect = document.getElementById("gender");
        const ageSelect = document.getElementById("age");
        const postcodeSearchButton = document.querySelector(".search-button");
        let postcode = "";

        let currentStep = 0;
        const totalSteps = 4;

        function updateForm() {
          formStepsContainer.style.transform = `translateX(-${(currentStep * 100) / totalSteps}%)`;

          formDots.forEach((dot, index) => {
            dot.classList.toggle("active", index === currentStep);
          });

          prevButton.style.display = currentStep > 0 ? "inline-block" : "none";
          nextButton.style.display = currentStep < totalSteps - 1 ? "inline-block" : "none";
          submitButton.style.display = currentStep === totalSteps - 1 ? "inline-block" : "none";

          checkButtonState();
        }

        function validateStep() {
          let isValid = true;

          if (currentStep === 0) {
            if (!nameInput.value.trim() || !phoneInput.value.trim() || !phoneInput.validity.valid) {
              isValid = false;
            }
            if (emailInput.value.trim() !== "" && !emailInput.validity.valid) {
              isValid = false;
            }
          } else if (currentStep === 1) {
            if (!hospitalNameInput.value.trim() || !specialtySelect.value.trim()) {
              isValid = false;
            }
          } else if (currentStep === 2) {
            if (!addressBaseInput.value.trim() || !addressDetailInput.value.trim()) {
              isValid = false;
            }
          } else if (currentStep === 3) {
            if (!genderSelect.value.trim() || !ageSelect.value.trim()) {
              isValid = false;
            }
            if (!privacyConsentCheckbox.checked) {
              isValid = false;
            }
          }
          return isValid;
        }

        function checkButtonState() {
          const isStepValid = validateStep();
          const targetButton = currentStep < totalSteps - 1 ? nextButton : submitButton;

          if (isStepValid) {
            targetButton.classList.remove("disabled");
            targetButton.disabled = false;
          } else {
            targetButton.classList.add("disabled");
            targetButton.disabled = true;
          }
        }

        // 다음 주소 api 호출
        function openPostcodeSearch() {
          new daum.Postcode({
            oncomplete: function (data) {
              // 도로명 주소의 노출 규칙에 따라 주소를 표시한다.
              // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
              let roadAddr = data.roadAddress; // 도로명 주소 변수
              let extraRoadAddr = ""; // 참고 항목 변수

              // 법정동명이 있을 경우 추가한다. (법정리는 제외)
              // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
              if (data.bname !== "" && /[동|로|가]$/g.test(data.bname)) {
                extraRoadAddr += data.bname;
              }
              // 건물명이 있고, 공동주택일 경우 추가한다.
              if (data.buildingName !== "") {
                extraRoadAddr += extraRoadAddr !== "" ? ", " + data.buildingName : data.buildingName;
              }
              // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
              if (extraRoadAddr !== "") {
                extraRoadAddr = " (" + extraRoadAddr + ")";
              }
              postcode = data.zonecode; // 우편번호 변수
              addressBaseInput.value = `${roadAddr}${extraRoadAddr}`;
            },
          }).open();
        }

        async function fetchData() {
          const overlay = document.getElementById("loadingOverlay");
          const resultEl = document.getElementById("result");

          // API 요청 데이터 구성
          const apiRequestData = [
            {
              card_dong_nm: postcode,
              sex: "M,F,Z",
              age: "A,B,C,D,E,F,G",
              card_sub: specialtySelect.value,
            },
            { card_dong_nm: postcode, sex: "M,F,Z", age: ageSelect.value, card_sub: specialtySelect.value },
            { card_dong_nm: postcode, sex: `${genderSelect.value},Z`, age: "A,B,C,D,E,F,G", card_sub: specialtySelect.value },
          ];

          try {
            // 1. 오버레이 보이기
            overlay.style.display = "flex";

            // 2. API 호출
            const response = await fetch("https://t.at.runcomm.co.kr/service/v1/post/health/care", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(apiRequestData),
            });
            const apiData = await response.json();

            const partnerOption = specialtySelect.options[specialtySelect.selectedIndex];
            const genderOption = genderSelect.options[genderSelect.selectedIndex];
            const ageOption = ageSelect.options[ageSelect.selectedIndex];
            const localData = {
              hospitalName: hospitalNameInput.value,
              generalData: {
                gender: genderOption.getAttribute("name"),
                age: ageOption.getAttribute("name"),
                partnerCd: partnerOption.getAttribute("name"),
              },
              resData: apiData,
            };
            // 로컬 스토리지에 데이터 저장
            localStorage.setItem("touchadData", JSON.stringify(localData));
            // r.html 페이지로 이동
            window.location.href = "r.html";
          } catch (err) {
            resultEl.innerHTML = `<p style="color:red;">에러 발생: ${err.message}</p>`;
          } finally {
            // 4. 로딩 표시 숨기기
            overlay.style.display = "none";
          }
        }

        postcodeSearchButton.addEventListener("click", () => {
          // 우편번호 검색 버튼 클릭 시
          openPostcodeSearch();
        });

        nextButton.addEventListener("click", () => {
          if (currentStep < totalSteps - 1 && validateStep()) {
            currentStep++;
            updateForm();
          }
        });

        prevButton.addEventListener("click", () => {
          if (currentStep > 0) {
            currentStep--;
            updateForm();
          }
        });

        // 실시간 입력 감지
        const allInputs = document.querySelectorAll("#multi-step-form input, #multi-step-form select");
        allInputs.forEach((input) => {
          input.addEventListener("input", checkButtonState);
        });
        privacyConsentCheckbox.addEventListener("change", checkButtonState);

        // submitButton에 클릭 이벤트 리스너 추가
        submitButton.addEventListener("click", async () => {
          // 최종 단계의 유효성 검사 통과 시
          if (validateStep()) {
            // 제출 버튼 비활성화
            submitButton.disabled = true;
            submitButton.textContent = "처리 중...";

            try {
              await fetchData();
            } catch (error) {
              console.error("API 요청 중 오류 발생:", error);
              // 에러 발생 시 버튼 상태 복원
              submitButton.disabled = false;
              submitButton.textContent = "제출";
            }
          } else {
            // 유효성 검사 실패 시 경고 메시지 표시
            alert("필수 정보를 모두 입력하고 개인정보 수집에 동의해주세요.");
          }
        });

        // 이메일 도메인 입력/선택 토글
        const emailDomainInput = document.getElementById("email-domain-input");
        const emailDomainSelect = document.getElementById("email-domain-select");
        const emailDomainToggle = document.getElementById("email-domain-toggle");

        // '▼' 버튼 클릭 시 select 박스 토글
        emailDomainToggle.addEventListener("click", () => {
          emailDomainInput.style.display = "none";
          emailDomainToggle.style.display = "none";
          emailDomainSelect.style.display = "block";
          emailDomainSelect.focus();
        });

        // select 박스 변경 시 input 값 갱신
        emailDomainSelect.addEventListener("change", (event) => {
          const selectedValue = event.target.value;

          if (selectedValue === "self") {
            emailDomainInput.value = "";
          } else {
            emailDomainInput.value = selectedValue;
          }

          // UI 원복
          emailDomainSelect.style.display = "none";
          emailDomainInput.style.display = "block";
          emailDomainToggle.style.display = "block";
        });

        // 초기화 시 버튼 상태 체크
        updateForm();

        /* 우측 섹션 이동 인디케이터 스크립트 */
        const mainContainer = document.querySelector(".scroll-container");
        const sections = document.querySelectorAll(".scroll-section");
        const sectionDots = document.querySelectorAll(".scroll-indicator .scroll-dot");

        function handleScrollIndicator() {
          const scrollTop = mainContainer.scrollTop;
          let currentSectionId = "hero-section";
          sections.forEach((section) => {
            const rect = section.getBoundingClientRect();
            // 뷰포트 중앙에 가장 가까운 섹션을 활성화
            if (rect.top <= window.innerHeight / 2 && rect.bottom >= window.innerHeight / 2) {
              currentSectionId = section.id;
            }
          });

          sectionDots.forEach((dot) => {
            dot.classList.toggle("active", dot.dataset.section === currentSectionId);
          });
        }

        mainContainer.addEventListener("scroll", handleScrollIndicator);
      });
      await fetch("/api/submit", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    name: nameInput.value,
    phone: phoneInput.value,
    email: emailInput.value,
    "hospital-name": hospitalNameInput.value,
    specialty: specialtySelect.value,
    "address-base": addressBaseInput.value,
    "address-detail": addressDetailInput.value,
    gender: genderSelect.value,
    age: ageSelect.value,
    "privacy-consent": privacyConsentCheckbox.checked,
  }),
});
    </script>
  </body>
</html>
